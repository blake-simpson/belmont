#!/bin/bash

# ralph-status: Show task completion summary from PRD.md (markdown format)

PRD_DIR="$HOME/.local"
PRD_FILE="$PRD_DIR/PRD.md"
PROGRESS_FILE="$PRD_DIR/PROGRESS.md"
ACTIVE_FILE="$PRD_DIR/ralph-active.json"

echo "Ralph Status"
echo "============"
echo ""

if [ ! -f "$PRD_FILE" ]; then
    echo "No PRD.md found at $PRD_FILE"
    exit 1
fi

# Check if file is empty or just has template header
content=$(cat "$PRD_FILE")
if [ -z "$content" ] || [ "$content" = "# PRD" ]; then
    echo "PRD is empty. Run 'ralph-plan' to create tasks."
    exit 0
fi

# Parse markdown PRD and show status
python3 << 'PYEOF'
import re
import os
import json

prd_file = os.path.expanduser("~/.local/PRD.md")
progress_file = os.path.expanduser("~/.local/PROGRESS.md")
active_file = os.path.expanduser("~/.local/ralph-active.json")

try:
    with open(prd_file, "r") as f:
        content = f.read()
except Exception as e:
    print(f"Error reading PRD: {e}")
    exit(1)

# Extract feature name from title
title_match = re.search(r'^#\s+PRD:\s*(.+)$', content, re.MULTILINE)
feature_name = title_match.group(1).strip() if title_match else "Unknown Feature"
print(f"Feature: {feature_name}")
print("")

# Load active tasks
active_tasks = []
try:
    with open(active_file, "r") as f:
        active_tasks = json.load(f)
except (FileNotFoundError, json.JSONDecodeError):
    active_tasks = []

# Load progress content
progress_content = ""
try:
    with open(progress_file, "r") as f:
        progress_content = f.read()
except FileNotFoundError:
    pass

# Find tasks by section headers - support both formats:
# Format 1: ### P0-1: Task Name
# Format 2: ### Task 1: Task Name
task_headers = re.findall(r'^###\s+(P\d+-\d+):\s*(.+?)$', content, re.MULTILINE)
task_headers_alt = re.findall(r'^###\s+(Task\s+\d+):\s*(.+?)$', content, re.MULTILINE)

# Build task info
all_tasks = []

# Process P0-1 format
priorities = {'P0': [], 'P1': [], 'P2': [], 'P3': []}
for task_id, task_name in task_headers:
    priority = task_id.split('-')[0]
    task_section = re.search(rf'###\s+{re.escape(task_id)}:.*?(?=\n###|\n---|\Z)', content, re.DOTALL)
    is_complete = False
    if task_section:
        section_text = task_section.group(0)
        is_complete = 'âœ…' in section_text[:100] or '[DONE]' in section_text[:100] or '~~' in task_name
    if priority in priorities:
        priorities[priority].append((task_id, task_name.strip(), is_complete))
    all_tasks.append((task_id, task_name.strip(), is_complete))

# Process Task N format
for task_id, task_name in task_headers_alt:
    # Check if task is marked complete (has âœ… or [DONE] in header line)
    is_complete = 'âœ…' in task_name or '[DONE]' in task_name
    # Clean up the task name
    clean_name = task_name.replace('âœ…', '').replace('[DONE]', '').strip()
    all_tasks.append((task_id, clean_name, is_complete))

# Calculate totals from all_tasks (works for both formats)
total_tasks = len(all_tasks)
completed_tasks = sum(1 for _, _, done in all_tasks if done)
pending_tasks = total_tasks - completed_tasks
in_progress_count = len(active_tasks)

# Determine status intelligently
# Priority: active tasks â†’ all complete â†’ last from PROGRESS.md â†’ default
if active_tasks:
    status = "ðŸŸ¡ In Progress"
elif total_tasks > 0 and completed_tasks == total_tasks:
    status = "ðŸŸ¢ Done"
else:
    # Find LAST status match in progress file (not first)
    status_matches = re.findall(r'^##\s+Status:\s*(.+)$', progress_content, re.MULTILINE)
    if status_matches:
        status = status_matches[-1].strip()
    else:
        status = "ðŸ”´ Not Started"

print(f"Status: {status}")
print("")

# Show task summary
if total_tasks > 0:
    parts = []
    if completed_tasks > 0:
        parts.append(f"{completed_tasks} done")
    if in_progress_count > 0:
        parts.append(f"{in_progress_count} in progress")
    if pending_tasks - in_progress_count > 0:
        parts.append(f"{pending_tasks - in_progress_count} pending")

    print(f"Tasks: {', '.join(parts)} (of {total_tasks})")
    print("")

    # Show task list with status icons
    for task_id, task_name, is_complete in all_tasks:
        # Check if this task is currently in progress
        task_in_progress = any(
            task_id in t.get('description', '') or task_name[:20] in t.get('description', '')
            for t in active_tasks
        )

        if is_complete:
            icon = "âœ…"
        elif task_in_progress:
            icon = "ðŸ”„"
        else:
            icon = "â¬œ"

        # Truncate long names
        display_name = task_name[:55] + "..." if len(task_name) > 55 else task_name
        # Remove âœ… from display name if already in icon
        display_name = display_name.replace(" âœ…", "").replace("âœ… ", "").replace("âœ…", "")
        print(f"  {icon} {task_id}: {display_name}")
    print("")

# Show in-progress task details
if active_tasks:
    print(f"In Progress: {len(active_tasks)} task(s)")
    for task in active_tasks:
        desc = task.get('description', 'Unknown')[:50]
        started = task.get('started', '?')
        sandbox = task.get('sandbox', '?')
        pid = task.get('pid', '?')
        print(f"  â€¢ {desc}...")
        print(f"    Started: {started} | PID: {pid} | Sandbox: {sandbox}")
    print("")

# Show milestones from progress file
try:
    if progress_content:
        milestones_section = re.search(r'##\s+Milestones.*?\n(.*?)(?=\n##|\Z)', progress_content, re.DOTALL)
        if milestones_section:
            milestones_text = milestones_section.group(1)
            milestone_headers = re.findall(r'###\s+([â¬œâœ…])\s+(M\d+:.*?)$', milestones_text, re.MULTILINE)
            if milestone_headers:
                print("Milestones:")
                for status_icon, name in milestone_headers:
                    print(f"  {status_icon} {name.strip()}")
                print("")
except Exception:
    pass

# Recent Activity - structured output
print("Recent Activity:")
print("---")

# Show last completed task
completed_list = [
    (task_id, task_name)
    for task_id, task_name, done in all_tasks
    if done
]
if completed_list:
    last_id, last_name = completed_list[-1]
    last_name = last_name.replace(" âœ…", "").replace("âœ… ", "").replace("âœ…", "").strip()
    print(f"Last completed: {last_id} - {last_name[:50]}")

# Show what's being worked on
if active_tasks:
    for task in active_tasks:
        desc = task.get('description', 'Unknown')
        print(f"Working on: {desc}")

# Show recent decisions from progress file (last 3)
if progress_content:
    decisions_section = re.search(r'##\s+Decisions Log.*?\n(.*?)(?=\n##|\Z)', progress_content, re.DOTALL)
    if decisions_section:
        decisions_text = decisions_section.group(1)
        # Find decision entries (usually bullet points with dates or descriptions)
        decision_lines = [
            line.strip()
            for line in decisions_text.split('\n')
            if line.strip() and line.strip().startswith('-')
        ]
        if decision_lines:
            print("")
            print("Recent decisions:")
            for line in decision_lines[-3:]:
                print(f"  {line}")
PYEOF
